<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Method | BOCOFAMCO Member</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Additional CSS styles to add to payment-method.ejs */

.payment-table .status-pending {
    color: var(--warning);
    font-weight: 500;
    background-color: var(--warning-bg);
    padding: 2px 8px;
    border-radius: 4px;
}

.payment-table .status-failed {
    color: var(--danger);
    font-weight: 500;
    background-color: var(--danger-bg);
    padding: 2px 8px;
    border-radius: 4px;
}

.payment-table .status-overdue {
    color: #d63384;
    font-weight: 500;
    background-color: #f8d7da;
    padding: 2px 8px;
    border-radius: 4px;
}

.payment-table .status-paid {
    background-color: var(--success-bg);
    padding: 2px 8px;
}

        :root {
            --primary: #4361ee;
            --primary-light: #e0e7ff;
            --primary-dark: #3a0ca3;
            --success: #4cc9f0;
            --success-bg: #e0f7ff;
            --warning: #f8961e;
            --warning-bg: #fff3e0;
            --danger: #f72585;
            --danger-bg: #ffebee;
            --text-primary: #2b2d42;
            --text-secondary: #4a4e69;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-color: #e9ecef;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .main-content {
            margin-left: 280px;
            padding: 1.5rem;
            transition: margin-left 0.3s ease;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-title i {
            font-size: 1.25rem;
            color: var(--primary);
        }

        .card {
            background-color: var(--bg-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .payment-info-section {
            background-color: var(--primary-light);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
        }

        .payment-info-item {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .payment-info-label {
            font-weight: 600;
            min-width: 120px;
            color: var(--primary-dark);
        }

        .payment-info-value {
            color: var(--text-primary);
        }

        .payment-method-section {
            text-align: center;
        }

        .payment-method-option {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--bg-white);
            transition: var(--transition);
        }

        .payment-method-option:hover {
            border-color: var(--primary-light);
            box-shadow: var(--shadow-sm);
        }

        .payment-method-option h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .payment-method-option p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .payment-method-option button {
            background-color: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: var(--transition);
        }

        .payment-method-option button:hover {
            background-color: var(--primary-dark);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--bg-white);
            padding: 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .close-modal:hover {
            color: var(--primary-dark);
        }

        .payment-method-form {
            padding: 20px;
        }

        .payment-method-form h3 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            margin-bottom: 15px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        .form-submit-btn {
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: block;
            margin: 20px auto 0;
            transition: var(--transition);
        }

        .form-submit-btn:hover:not(:disabled) {
            background-color: var(--primary-dark);
        }

        .form-submit-btn:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
        }

        .qr-code-placeholder {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        .payment-details {
            background-color: var(--bg-light);
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .payment-details p {
            margin: 5px 0;
            font-size: 0.875rem;
        }

        .payment-details strong {
            color: var(--primary-dark);
        }

        .payment-success {
            text-align: center;
            padding: 20px;
        }

        .payment-success i {
            font-size: 3rem;
            color: var(--success);
            margin-bottom: 15px;
        }

        .payment-success h3 {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .payment-success p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .loading-message {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }

            .qr-code-placeholder {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <% const currentPage = 'payment-method'; %>
    <!-- Placeholder for membersidebar partial -->
    <%- include('../partials/membersidebar', { currentPage }) %>

    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-credit-card"></i>
                Select Payment Method
            </h1>
        </div>

        <div class="card">
            <!-- Payment Information Section -->
            <div class="payment-info-section">
                <div class="payment-info-item">
                    <span class="payment-info-label">CB Number:</span>
                    <span class="payment-info-value"><%= typeof cbNumber !== 'undefined' ? cbNumber : 'N/A' %></span>
                </div>
                <div class="payment-info-item">
                    <span class="payment-info-label">Loan ID:</span>
                    <span class="payment-info-value" id="loanIdDisplay"><%= loanId || 'N/A' %></span>
                </div>
                <div class="payment-info-item">
                    <span class="payment-info-label">Loan Type:</span>
                    <span class="payment-info-value" id="loanTypeDisplay"><%= loanType === 'regular/agricultural' ? 'Regular/Agricultural Loan' : loanType === 'salary' ? 'Salary Loan' : loanType === 'bonuses' ? 'Bonuses Loan' : loanType === 'agricultural' ? 'Regular/Agricultural Loan' : 'Unknown' %></span>
                </div>
                <div class="payment-info-item">
                    <span class="payment-info-label">Amount Due:</span>
                    <span class="payment-info-value">₱<span id="amountDueDisplay"><%= amountDue ? parseFloat(amountDue).toLocaleString('en-US', { minimumFractionDigits: 2 }) : '0.00' %></span></span>
                </div>
            </div>

            <div class="payment-method-section">
                <div class="payment-method-option">
                    <h3>GCash</h3>
                    <p>Pay conveniently using your GCash account. Scan the QR code or enter the payment details provided upon confirmation.</p>
                    <button onclick="selectPaymentMethod('GCash')">Choose GCash</button>
                </div>
                <div class="payment-method-option">
                    <h3>ATM</h3>
                    <p>BOCOFAMCO will process the payment using your provided ATM card.</p>
                    <button onclick="selectPaymentMethod('ATM')">Choose ATM</button>
                </div>
                <div class="payment-method-option">
                    <h3>Over the Counter</h3>
                    <p>Visit our office to make a cash or check payment directly at the counter.</p>
                    <button onclick="selectPaymentMethod('Over the Counter')">Choose Over the Counter</button>
                </div>
            </div>
        </div>

<!-- GCash Payment Modal -->
<div class="modal" id="gcashPaymentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">GCash Payment</h2>
            <button class="close-modal" onclick="closeModal('gcashPaymentModal')">&times;</button>
        </div>
        <div class="payment-method-form">
            <img id="qrcode" class="qr-code-placeholder" src="../images/gcash.png" alt="GCash QR Code" style="display: block; margin: 0 auto; width: auto; height: auto; max-width: 100%; max-height: 400px;">
            <div class="payment-details">
                <p><strong>CB Number:</strong> <%= typeof cbNumber !== 'undefined' ? cbNumber : 'N/A' %></p>
                <p><strong>Loan ID:</strong> <span id="gcashLoanIdDisplay"><%= loanId || 'N/A' %></span></p>
                <p><strong>Recipient:</strong> BOCOFAMCO Cooperative</p>
                <p><strong>GCash Number:</strong> 09633044342</p>
                <p><strong>Reference Number:</strong> <span id="gcashRefNumber">GC-<%= Math.floor(100000 + Math.random() * 900000) %></span></p>
                <p><strong>Amount Due:</strong> ₱<span id="gcashAmountDue"><%= amountDue ? parseFloat(amountDue).toLocaleString('en-US', { minimumFractionDigits: 2 }) : '0.00' %></span></p>
                <p><strong>Loan Type:</strong> <span id="gcashLoanTypeDisplay"><%= loanType === 'regular/agricultural' ? 'Regular/Agricultural Loan' : loanType === 'salary' ? 'Salary Loan' : loanType === 'bonuses' ? 'Bonuses Loan' : loanType === 'agricultural' ? 'Regular/Agricultural Loan' : 'Unknown' %></span></p>
            </div>
            <h3>Payment Confirmation</h3>
            <form id="gcashPaymentForm">
                <input type="hidden" id="gcashCbNumber" name="cbNumber" value="<%= typeof cbNumber !== 'undefined' ? cbNumber : '' %>">
                <input type="hidden" id="gcashLoanId" name="loanId" value="<%= loanId || '' %>">
                <input type="hidden" id="gcashLoanType" name="loanType">
                <div class="form-group">
                    <label for="gcashFullName">Full Name</label>
                    <input type="text" id="gcashFullName" required>
                </div>
                <div class="form-group">
                    <label for="gcashReference">GCash Reference Number</label>
                    <input type="text" id="gcashReference" required placeholder="Enter GCash transaction reference">
                </div>
                <div class="form-group">
                    <label for="gcashAmount">Amount Paid</label>
                    <input type="number" id="gcashAmount" step="0.01" required placeholder="Enter amount sent">
                </div>
                <div class="form-group">
                    <label for="gcashPaymentType">Payment Type</label>
                    <select id="gcashPaymentType" required>
                        <option value="">Select payment type</option>
                        <option value="full">Full Payment</option>
                        <option value="partial">Partial Payment</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gcashReceipt">Upload Receipt (Optional)</label>
                    <input type="file" id="gcashReceipt" accept="image/*">
                </div>
                <button type="submit" class="form-submit-btn" id="gcashSubmitBtn">Submit Payment</button>
                <div id="gcashLoadingMessage" class="loading-message" style="display: none;">Processing your payment...</div>
            </form>
        </div>
    </div>
</div>

        <!-- ATM Payment Modal -->
        <div class="modal" id="atmPaymentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">ATM Payment</h2>
                    <button class="close-modal" onclick="closeModal('atmPaymentModal')">&times;</button>
                </div>
                <div class="payment-method-form">
                    <div class="payment-details">
                        <p><strong>CB Number:</strong> <%= typeof cbNumber !== 'undefined' ? cbNumber : 'N/A' %></p>
                        <p><strong>Loan ID:</strong> <span id="atmLoanIdDisplay"><%= loanId || 'N/A' %></span></p>
                        <p><strong>Payment Method:</strong> Automatic ATM Deduction</p>
                        <p><strong>Reference Number:</strong> <span id="atmRefNumber">ATM-<%= Math.floor(100000 + Math.random() * 900000) %></span></p>
                        <p><strong>Amount Due:</strong> ₱<span id="atmAmountDue"><%= amountDue ? parseFloat(amountDue).toLocaleString('en-US', { minimumFractionDigits: 2 }) : '0.00' %></span></p>
                        <p><strong>Next Deduction Date:</strong> <span id="atmNextDeductionDate"><%= new Date(new Date().setDate(new Date().getDate() + 7)).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></span></p>
                        <p><strong>Loan Type:</strong> <span id="atmLoanTypeDisplay"><%= loanType === 'regular/agricultural' ? 'Regular/Agricultural Loan' : loanType === 'salary' ? 'Salary Loan' : loanType === 'bonuses' ? 'Bonuses Loan' : loanType === 'agricultural' ? 'Regular/Agricultural Loan' : 'Unknown' %></span></p>
                    </div>
                    <h3>Payment Authorization</h3>
                    <form id="atmPaymentForm">
                        <input type="hidden" id="atmCbNumber" name="cbNumber" value="<%= typeof cbNumber !== 'undefined' ? cbNumber : '' %>">
                        <input type="hidden" id="atmLoanId" name="loanId" value="<%= loanId || '' %>">
                        <input type="hidden" id="atmLoanType" name="loanType">
                        <div class="form-group">
                            <label for="atmFullName">Full Name</label>
                            <input type="text" id="atmFullName" required>
                        </div>
                        <div class="form-group">
                            <label for="atmCardNumber">ATM Card Number (Last 4 digits)</label>
                            <input type="text" id="atmCardNumber" pattern="\d{4}" maxlength="4" required placeholder="Last 4 digits">
                        </div>
                        <div class="form-group">
                            <label for="atmBank">Bank Name</label>
                            <select id="atmBank" required>
                                <option value="">Select your bank</option>
                                <option value="BDO">BDO</option>
                                <option value="BPI">BPI</option>
                                <option value="Metrobank">Metrobank</option>
                                <option value="Landbank">Landbank</option>
                                <option value="PNB">PNB</option>
                                <option value="UnionBank">UnionBank</option>
                                <option value="Other">Other Bank</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="atmAmount">Amount to Deduct</label>
                            <input type="number" id="atmAmount" step="0.01" required placeholder="Enter amount to deduct">
                        </div>
                        <div class="form-group">
                            <label for="atmPaymentType">Payment Type</label>
                            <select id="atmPaymentType" required>
                                <option value="">Select payment type</option>
                                <option value="full">Full Payment</option>
                                <option value="partial">Partial Payment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="atmAuthorization" required>
                                I authorize BOCOFAMCO to deduct payments from my ATM account
                            </label>
                        </div>
                        <button type="submit" class="form-submit-btn" id="atmSubmitBtn">Authorize Payment</button>
                        <div id="atmLoadingMessage" class="loading-message" style="display: none;">Processing your authorization...</div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Over the Counter Payment Modal -->
        <div class="modal" id="otcPaymentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Over the Counter Payment</h2>
                    <button class="close-modal" onclick="closeModal('otcPaymentModal')">&times;</button>
                </div>
                <div class="payment-method-form">
                    <div class="payment-details">
                        <p><strong>CB Number:</strong> <%= typeof cbNumber !== 'undefined' ? cbNumber : 'N/A' %></p>
                        <p><strong>Loan ID:</strong> <span id="otcLoanIdDisplay"><%= loanId || 'N/A' %></span></p>
                        <p><strong>Payment Method:</strong> Over the Counter</p>
                        <p><strong>Reference Number:</strong> <span id="otcRefNumber">OTC-<%= Math.floor(100000 + Math.random() * 900000) %></span></p>
                        <p><strong>Amount Due:</strong> ₱<span id="otcAmountDue"><%= amountDue ? parseFloat(amountDue).toLocaleString('en-US', { minimumFractionDigits: 2 }) : '0.00' %></span></p>
                        <p><strong>Payment Location:</strong> BOCOFAMCO Main Office, 123 Cooperative St., City</p>
                        <p><strong>Office Hours:</strong> Monday-Friday, 8:00 AM - 5:00 PM</p>
                        <p><strong>Loan Type:</strong> <span id="otcLoanTypeDisplay"><%= loanType === 'regular/agricultural' ? 'Regular/Agricultural Loan' : loanType === 'salary' ? 'Salary Loan' : loanType === 'bonuses' ? 'Bonuses Loan' : loanType === 'agricultural' ? 'Regular/Agricultural Loan' : 'Unknown' %></span></p>
                    </div>
                    <h3>Schedule Your Payment</h3>
                    <form id="otcPaymentForm">
                        <input type="hidden" id="otcCbNumber" name="cbNumber" value="<%= typeof cbNumber !== 'undefined' ? cbNumber : '' %>">
                        <input type="hidden" id="otcLoanId" name="loanId" value="<%= loanId || '' %>">
                        <input type="hidden" id="otcLoanType" name="loanType">
                        <div class="form-group">
                            <label for="otcFullName">Full Name</label>
                            <input type="text" id="otcFullName" required>
                        </div>
                        <div class="form-group">
                            <label for="otcPaymentDate">Preferred Payment Date</label>
                            <input type="date" id="otcPaymentDate" required min="<%= new Date().toISOString().split('T')[0] %>">
                        </div>
                        <div class="form-group">
                            <label for="otcPaymentTime">Preferred Time</label>
                            <select id="otcPaymentTime" required>
                                <option value="">Select time</option>
                                <option value="08:00">8:00 AM</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="otcPaymentType">Payment Type</label>
                            <select id="otcPaymentType" required>
                                <option value="">Select payment type</option>
                                <option value="full">Full Payment</option>
                                <option value="partial">Partial Payment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="otcAmount">Amount to Pay</label>
                            <input type="number" id="otcAmount" step="0.01" required placeholder="Enter amount to pay">
                        </div>
                        <div class="form-group">
                            <label for="otcPaymentMethod">Payment Method</label>
                            <select id="otcPaymentMethod" required>
                                <option value="">Select payment method</option>
                                <option value="Cash">Cash</option>
                                <option value="Check">Check</option>
                            </select>
                        </div>
                        <div class="form-group" id="otcCheckDetails" style="display: none;">
                            <label for="otcCheckNumber">Check Number</label>
                            <input type="text" id="otcCheckNumber" placeholder="Enter check number">
                        </div>
                        <button type="submit" class="form-submit-btn" id="otcSubmitBtn">Schedule Payment</button>
                        <div id="otcLoadingMessage" class="loading-message" style="display: none;">Scheduling your payment...</div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Payment Success Modal -->
        <div class="modal" id="paymentSuccessModal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="payment-success">
                    <i class="fas fa-check-circle"></i>
                    <h3>Payment Submitted Successfully!</h3>
                    <p>Your payment details have been received and will be processed within 1-2 business days.</p>
                    <p><strong>CB Number:</strong> <span id="successCbNumber"><%= typeof cbNumber !== 'undefined' ? cbNumber : 'N/A' %></span></p>
                    <p><strong>Loan ID:</strong> <span id="successLoanId"><%= loanId || 'N/A' %></span></p>
                    <p><strong>Reference Number:</strong> <span id="successRefNumber"></span></p>
                    <p><strong>Payment Type:</strong> <span id="successPaymentType"></span></p>
                    <p><strong>Amount Paid:</strong> ₱<span id="successAmountPaid"></span></p>
                    <button class="form-submit-btn" onclick="closeModal('paymentSuccessModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global submission flag
        let isSubmitting = false;

        // Initialize payment method page
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            let loanId = urlParams.get('loanId') || sessionStorage.getItem('currentLoanId') || '';
            let loanType = urlParams.get('loanType') || sessionStorage.getItem('currentLoanType') || '';
            const amountDue = parseFloat(urlParams.get('amountDue') || sessionStorage.getItem('currentAmountDue') || '0');
            const nextPaymentIndex = parseInt(urlParams.get('nextPaymentIndex') || sessionStorage.getItem('nextPaymentIndex') || '0');
            const cbNumber = '<%= cbNumber %>';

            // Map loanType to match database enum
            const loanTypeMap = {
                'agricultural': 'Regular/Agricultural',
                'regular/agricultural': 'Regular/Agricultural',
                'salary': 'Salary',
                'bonuses': 'Bonuses'
            };
            loanType = loanTypeMap[loanType.toLowerCase()] || loanType;

            // Store in sessionStorage for consistency
            sessionStorage.setItem('currentLoanId', loanId);
            sessionStorage.setItem('currentLoanType', loanType);
            sessionStorage.setItem('currentAmountDue', amountDue);
            sessionStorage.setItem('nextPaymentIndex', nextPaymentIndex);
            sessionStorage.setItem('cbNumber', cbNumber);

            // Update amount due in all payment modals
            document.getElementById('gcashAmountDue').textContent = amountDue.toLocaleString('en-US', { minimumFractionDigits: 2 });
            document.getElementById('atmAmountDue').textContent = amountDue.toLocaleString('en-US', { minimumFractionDigits: 2 });
            document.getElementById('otcAmountDue').textContent = amountDue.toLocaleString('en-US', { minimumFractionDigits: 2 });
            document.getElementById('amountDueDisplay').textContent = amountDue.toLocaleString('en-US', { minimumFractionDigits: 2 });

            // Update loan type display
            const displayLoanType = loanType === 'Regular/Agricultural' ? 'Regular/Agricultural Loan' : 
                                   loanType === 'Salary' ? 'Salary Loan' : 
                                   loanType === 'Bonuses' ? 'Bonuses Loan' : 'Unknown';
            document.getElementById('gcashLoanTypeDisplay').textContent = displayLoanType;
            document.getElementById('atmLoanTypeDisplay').textContent = displayLoanType;
            document.getElementById('otcLoanTypeDisplay').textContent = displayLoanType;
            document.getElementById('loanTypeDisplay').textContent = displayLoanType;

            // Set hidden loan type inputs
            document.getElementById('gcashLoanType').value = loanType;
            document.getElementById('atmLoanType').value = loanType;
            document.getElementById('otcLoanType').value = loanType;

            // Set CB number and loan ID in all forms
            document.querySelectorAll('[id$="CbNumber"]').forEach(el => el.value = cbNumber);
            document.querySelectorAll('[id$="LoanId"]').forEach(el => el.value = loanId);

            // Show/hide check details for OTC payment
            document.getElementById('otcPaymentMethod').addEventListener('change', function() {
                document.getElementById('otcCheckDetails').style.display = this.value === 'Check' ? 'block' : 'none';
            });
        });

        function selectPaymentMethod(method) {
            if (method === 'GCash') {
                document.getElementById('gcashPaymentModal').style.display = 'flex';
            } else if (method === 'ATM') {
                document.getElementById('atmPaymentModal').style.display = 'flex';
            } else if (method === 'Over the Counter') {
                document.getElementById('otcPaymentModal').style.display = 'flex';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(event) {
                if (event.target === this) {
                    closeModal(this.id);
                }
            });
        });

        // Generic submit payment function with double submission prevention
        async function submitPayment(formId, endpoint, formData, submitBtnId, loadingMessageId, successCallback) {
            // Prevent double submission
            if (isSubmitting) {
                console.log('Already submitting, please wait...');
                return false;
            }
            
            isSubmitting = true;
            
            // Disable submit button and show loading
            const submitBtn = document.getElementById(submitBtnId);
            const loadingMessage = document.getElementById(loadingMessageId);
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                submitBtn.style.opacity = '0.7';
            }
            
            if (loadingMessage) {
                loadingMessage.style.display = 'block';
            }
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (successCallback) {
                        successCallback(result);
                    }
                    return true;
                } else {
                    alert('Error submitting payment: ' + (result.message || 'Unknown error'));
                    return false;
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert('Error submitting payment: ' + error.message);
                return false;
            } finally {
                // Re-enable form
                isSubmitting = false;
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = submitBtn.dataset.originalText || 'Submit Payment';
                    submitBtn.style.opacity = '1';
                }
                
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }
            }
        }

        // GCash Form Submission
        document.getElementById('gcashPaymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nextPaymentIndex = sessionStorage.getItem('nextPaymentIndex') || '0';
            
            const formData = {
                cbNumber: document.getElementById('gcashCbNumber').value,
                loanId: document.getElementById('gcashLoanId').value,
                loanType: document.getElementById('gcashLoanType').value,
                gcashAmount: document.getElementById('gcashAmount').value,
                gcashPaymentType: document.getElementById('gcashPaymentType').value,
                gcashReference: document.getElementById('gcashReference').value,
                gcashFullName: document.getElementById('gcashFullName').value,
                nextPaymentIndex: parseInt(nextPaymentIndex) + 1 // Convert to 1-based sequence
            };

            const submitBtn = document.getElementById('gcashSubmitBtn');
            submitBtn.dataset.originalText = submitBtn.textContent;

            const successCallback = (result) => {
                document.getElementById('successRefNumber').textContent = result.referenceNumber;
                document.getElementById('successPaymentType').textContent = formData.gcashPaymentType === 'full' ? 'Full Payment' : 'Partial Payment';
                document.getElementById('successAmountPaid').textContent = parseFloat(formData.gcashAmount).toLocaleString('en-US', { minimumFractionDigits: 2 });
                closeModal('gcashPaymentModal');
                document.getElementById('paymentSuccessModal').style.display = 'flex';
                
                // Refresh payment schedule after successful submission
                setTimeout(() => {
                    location.reload();
                }, 3000);
            };

            await submitPayment('gcashPaymentForm', '/payment/gcash', formData, 'gcashSubmitBtn', 'gcashLoadingMessage', successCallback);
        });

        // ATM Form Submission
        document.getElementById('atmPaymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nextPaymentIndex = sessionStorage.getItem('nextPaymentIndex') || '0';
            
            const formData = {
                cbNumber: document.getElementById('atmCbNumber').value,
                loanId: document.getElementById('atmLoanId').value,
                loanType: document.getElementById('atmLoanType').value,
                atmAmount: document.getElementById('atmAmount').value,
                atmPaymentType: document.getElementById('atmPaymentType').value,
                atmCardNumber: document.getElementById('atmCardNumber').value,
                atmBank: document.getElementById('atmBank').value,
                atmFullName: document.getElementById('atmFullName').value,
                nextPaymentIndex: parseInt(nextPaymentIndex) + 1 // Convert to 1-based sequence
            };

            const submitBtn = document.getElementById('atmSubmitBtn');
            submitBtn.dataset.originalText = submitBtn.textContent;

            const successCallback = (result) => {
                document.getElementById('successRefNumber').textContent = result.referenceNumber;
                document.getElementById('successPaymentType').textContent = formData.atmPaymentType === 'full' ? 'Full Payment' : 'Partial Payment';
                document.getElementById('successAmountPaid').textContent = parseFloat(formData.atmAmount).toLocaleString('en-US', { minimumFractionDigits: 2 });
                closeModal('atmPaymentModal');
                document.getElementById('paymentSuccessModal').style.display = 'flex';
                
                // Refresh payment schedule after successful submission
                setTimeout(() => {
                    location.reload();
                }, 3000);
            };

            await submitPayment('atmPaymentForm', '/payment/atm', formData, 'atmSubmitBtn', 'atmLoadingMessage', successCallback);
        });

        // OTC Form Submission
        document.getElementById('otcPaymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nextPaymentIndex = sessionStorage.getItem('nextPaymentIndex') || '0';
            
            const formData = {
                cbNumber: document.getElementById('otcCbNumber').value,
                loanId: document.getElementById('otcLoanId').value,
                loanType: document.getElementById('otcLoanType').value,
                otcAmount: document.getElementById('otcAmount').value,
                otcPaymentType: document.getElementById('otcPaymentType').value,
                otcFullName: document.getElementById('otcFullName').value,
                otcPaymentDate: document.getElementById('otcPaymentDate').value,
                otcPaymentTime: document.getElementById('otcPaymentTime').value,
                otcPaymentMethod: document.getElementById('otcPaymentMethod').value,
                otcCheckNumber: document.getElementById('otcCheckNumber').value,
                nextPaymentIndex: parseInt(nextPaymentIndex) + 1 // Convert to 1-based sequence
            };

            const submitBtn = document.getElementById('otcSubmitBtn');
            submitBtn.dataset.originalText = submitBtn.textContent;

            const successCallback = (result) => {
                document.getElementById('successRefNumber').textContent = result.referenceNumber;
                document.getElementById('successPaymentType').textContent = formData.otcPaymentType === 'full' ? 'Full Payment' : 'Partial Payment';
                document.getElementById('successAmountPaid').textContent = parseFloat(formData.otcAmount).toLocaleString('en-US', { minimumFractionDigits: 2 });
                closeModal('otcPaymentModal');
                document.getElementById('paymentSuccessModal').style.display = 'flex';
                
                // Refresh payment schedule after successful submission
                setTimeout(() => {
                    location.reload();
                }, 3000);
            };

            await submitPayment('otcPaymentForm', '/payment/otc', formData, 'otcSubmitBtn', 'otcLoadingMessage', successCallback);
        });

        // Set minimum date for OTC payment date
        document.getElementById('otcPaymentDate').min = new Date().toISOString().split('T')[0];

        // Updated JavaScript for payment-method.ejs
function showPaymentSchedule(loanId, loanType, loanAmount, transactionDate) {
    const modal = document.getElementById('paymentScheduleModal');
    const container = document.getElementById('paymentScheduleContainer');

    // Clear previous content
    container.innerHTML = '';

    // Validate loan amount
    loanAmount = parseFloat(loanAmount) || 0;
    if (loanAmount <= 0) {
        container.innerHTML = '<p>No valid loan amount provided.</p>';
        modal.style.display = 'flex';
        return;
    }

    // Get payment status from server
    fetch(`/payment/status/${loanId}/${loanType}`)
        .then(response => response.json())
        .then(data => {
            generatePaymentScheduleWithStatus(loanId, loanType, loanAmount, transactionDate, data.payments || []);
            modal.style.display = 'flex';
        })
        .catch(error => {
            console.error('Error fetching payment status:', error);
            generatePaymentScheduleWithStatus(loanId, loanType, loanAmount, transactionDate, []);
            modal.style.display = 'flex';
        });
}

function generatePaymentScheduleWithStatus(loanId, loanType, loanAmount, transactionDate, existingPayments) {
    const container = document.getElementById('paymentScheduleContainer');

    // Determine loan term based on amount
    const loanTermMonths = loanAmount >= 100000 ? 24 : 12;

    // Determine if regular/agricultural or salary/bonuses
    const isRegular = loanType !== 'salary' && loanType !== 'bonuses';

    const interestRate = isRegular ? 0.03 : 0.01;
    const paymentFrequency = isRegular ? 'monthly' : 'semi-monthly';
    const paymentsPerMonth = isRegular ? 1 : 2;
    const totalPayments = loanTermMonths * paymentsPerMonth;
    const principalPerPayment = Math.round(loanAmount / totalPayments);
    const paymentIntervalDays = isRegular ? 30 : 15;
    const interestLabel = isRegular ? 'Interest (3%)' : 'Interest (1%)';

    let remainingBalance = loanAmount;
    let totalInterest = 0;
    let totalPayment = 0;
    let amountDue = 0;
    let nextPaymentIndex = 0;

    // Current date for status determination
    const currentDate = new Date();

    // Use transaction date or current date as the starting point
    const startDate = transactionDate ? new Date(transactionDate) : new Date();
    startDate.setDate(startDate.getDate() + paymentIntervalDays); // First payment due

    // Create a map of payment statuses by sequence
    const paymentStatusMap = {};
    existingPayments.forEach(payment => {
        const sequence = payment.payment_sequence || 1;
        if (!paymentStatusMap[sequence] || payment.created_at > paymentStatusMap[sequence].created_at) {
            paymentStatusMap[sequence] = payment;
        }
    });

    // Find next unpaid payment
    let foundNextPayment = false;

    // Create table for payment schedule
    const table = document.createElement('table');
    table.className = 'payment-table';

    // Create table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    ['#', 'Due Date', 'Principal', interestLabel, 'Total Payment', 'Remaining Balance', 'Status'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Create table body
    const tbody = document.createElement('tbody');

    for (let payment = 0; payment < totalPayments; payment++) {
        const sequence = payment + 1;
        const interest = Math.round(remainingBalance * interestRate);
        const totalPerPayment = principalPerPayment + interest;

        // Update totals
        totalInterest += interest;
        totalPayment += totalPerPayment;

        // Calculate due date
        const dueDate = new Date(startDate);
        dueDate.setDate(startDate.getDate() + payment * paymentIntervalDays);

        // Determine status based on payments made
        let paymentStatus = 'Unpaid';
        let statusClass = 'status-unpaid';

        if (paymentStatusMap[sequence]) {
            const paymentRecord = paymentStatusMap[sequence];
            if (paymentRecord.status === 'Completed') {
                paymentStatus = 'Paid';
                statusClass = 'status-paid';
            } else if (paymentRecord.status === 'Pending') {
                paymentStatus = 'Pending';
                statusClass = 'status-pending';
            } else if (paymentRecord.status === 'Failed') {
                paymentStatus = 'Failed';
                statusClass = 'status-failed';
            }
        } else if (dueDate < currentDate) {
            // Overdue payments that haven't been submitted
            paymentStatus = 'Overdue';
            statusClass = 'status-overdue';
        }

        // Set next payment due amount
        if (!foundNextPayment && (paymentStatus === 'Unpaid' || paymentStatus === 'Overdue')) {
            amountDue = totalPerPayment;
            nextPaymentIndex = payment;
            foundNextPayment = true;
        }

        // Create row
        const row = document.createElement('tr');

        // Sequence number cell
        const sequenceCell = document.createElement('td');
        sequenceCell.textContent = sequence;
        sequenceCell.style.fontWeight = '600';
        row.appendChild(sequenceCell);

        // Due Date cell
        const dateCell = document.createElement('td');
        dateCell.textContent = dueDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        row.appendChild(dateCell);

        // Principal cell
        const principalCell = document.createElement('td');
        principalCell.textContent = '₱' + principalPerPayment.toLocaleString();
        row.appendChild(principalCell);

        // Interest cell
        const interestCell = document.createElement('td');
        interestCell.textContent = '₱' + interest.toLocaleString();
        row.appendChild(interestCell);

        // Total payment cell
        const paymentCell = document.createElement('td');
        paymentCell.textContent = '₱' + totalPerPayment.toLocaleString();
        row.appendChild(paymentCell);

        // Remaining balance cell
        remainingBalance = Math.max(0, remainingBalance - principalPerPayment);
        const balanceCell = document.createElement('td');
        balanceCell.textContent = '₱' + remainingBalance.toLocaleString();
        row.appendChild(balanceCell);

        // Status cell
        const statusCell = document.createElement('td');
        statusCell.textContent = paymentStatus;
        statusCell.className = statusClass;
        row.appendChild(statusCell);

        tbody.appendChild(row);
    }

    table.appendChild(tbody);
    container.appendChild(table);

    // Add summary
    const summary = document.createElement('div');
    summary.className = 'payment-summary';
    summary.innerHTML = `
        <p>Loan Term: <span>${loanTermMonths} months (${totalPayments} ${paymentFrequency} payments)</span></p>
        <p>${paymentFrequency.charAt(0).toUpperCase() + paymentFrequency.slice(1)} Principal: <span>₱${principalPerPayment.toLocaleString()}</span></p>
        <p>Total Interest: <span>₱${totalInterest.toLocaleString()}</span></p>
        <p>Total Payment: <span>₱${totalPayment.toLocaleString()}</span></p>
        <p>Next Amount Due: <span>₱${amountDue.toLocaleString()}</span></p>
    `;
    container.appendChild(summary);

    // Store data for payment page
    sessionStorage.setItem('currentLoanId', loanId);
    sessionStorage.setItem('currentLoanType', loanType);
    sessionStorage.setItem('currentAmountDue', amountDue);
    sessionStorage.setItem('nextPaymentIndex', nextPaymentIndex);
}
    </script>
</body>
</html>